# AGENTS.md (Anti-Power Project Key Context)

English | [中文](AGENTS-zh.md)

> Goal: Let AI quickly understand what this project does, how patches are applied, and where key entry points are.

## Project Positioning

- Anti-Power is an enhancement patch for Antigravity AI IDE.
- Main enhancements for sidebar dialog area (cascade-panel) and Manager window: Mermaid rendering, math formula rendering, one-click copy, table color fix, font size control, etc.
- Supports Windows/macOS/Linux; on macOS/Linux you can use installer builds or `patcher/patches/anti-power.sh` (see `README.md` / `patcher/patches/manual-install.md`).

## Patch Deployment Flow (Core Chain)

1. Desktop installer located at `patcher/` (Tauri + Vue).
2. Rust backend handles: path detection, install/uninstall, config update (`patcher/src-tauri/src/commands/*.rs`).
3. During installation:
   - Backup `resources/app/extensions/antigravity/cascade-panel.html` as `.bak`
   - Write patch files and `cascade-panel/` directory
   - Generate `cascade-panel/config.json` (feature toggles)
4. Patch files sourced from `patcher/patches/`, embed manifest auto-generated by `patcher/src-tauri/build.rs` (exclude list `patcher/patches/.embed-exclude.txt`), `patcher/src-tauri/src/embedded.rs` includes manifest via `include!`.

## Key Directories (Modification Priority)

- `patcher/patches/`: Patch source files injected into Antigravity (HTML/JS/CSS).
- `patcher/src-tauri/`: Installer backend logic (path detection, backup/write, config).
- `patcher/src/`: Installer frontend UI (feature toggles, install/uninstall buttons).
- `docs/`: Development, release, structure, known issues and screenshots (see `docs/README.md`).
- `docs/guides/developer-guide_EN.md`: Comprehensive developer documentation (English) with DOM structure, code conventions, and development workflow.
- `tests/scripts/`: Playwright scripts for remote debugging Antigravity Manager window DOM.
- `patcher/patches/manual-install.md`: Manual installation instructions bundled with patch zip (Windows/macOS).
- `patcher/patches/workbench-jetski-agent.html` + `patcher/patches/manager-panel/`: Manager window patch entry and modules.

## Antigravity Internal Hook Points

- Sidebar: `resources/app/extensions/antigravity/cascade-panel.html`
- Manager window: `resources/app/out/vs/code/electron-browser/workbench/workbench-jetski-agent.html`
- ~~Note: Modifying `workbench-jetski-agent.html` triggers "Extension corrupted" prompt~~ (Fixed in v2.3.2+)

## Runtime Logic Overview (Sidebar Patch)

- Entry: `patcher/patches/cascade-panel.html` -> `cascade-panel/cascade-panel.js`
- `cascade-panel.js` reads `config.json`, loads modules on demand and starts scanning.
- `scan.js` triggers rendering and copy button injection based on DOM monitoring and content stability detection.

## Build and Release (Installer)

- In `patcher/`:
  - `npm run tauri:dev`
  - `npm run tauri:build`
- Before release, sync version numbers: `patcher/package.json`, `patcher/src-tauri/tauri.conf.json`, `patcher/src-tauri/Cargo.toml`, `patcher/src/App.vue`, `README.md` (see `docs/guides/release-guide.md`).

## Important Constraints/Risks

- Embed manifest auto-generated by build.rs; when adding/removing patch files, check if `.embed-exclude.txt` needs update (e.g., `config.json`, docs).
- Installation logic uses whitelist: sidebar only `cascade-panel.html` + `cascade-panel/`, Manager only `workbench-jetski-agent.html` + `manager-panel/`.
- Antigravity official updates will overwrite patches, requiring reinstallation.
- Known issue: LaTeX formulas containing `|` in tables render incorrectly (see `docs/reference/known-issues.md`).

## Development Notes (Tools/Environment)

- Documentation uses English punctuation uniformly (both Chinese and English content use English punctuation) to avoid tool processing issues with Chinese punctuation.
- `apply_patch` may trigger `byte index ... is not a char boundary` with long Chinese content, causing patch failure.
  - Solution: Use elevated PowerShell `Set-Content -Encoding UTF8` to write directly, or write ASCII first then append in segments.
- Writing to `patcher/patches/` or cleaning `tests/` may get `Access denied` in sandbox, need elevated commands for write/delete.

## Recent Enhancements (v2.3.x)

- KaTeX CSS and JS parallel loading for faster first render
- Bottom-right persistent copy button; removed feedback area (good/bad) copy button
- Top-right copy button repositioned to avoid text overlap
- Nested list support with code blocks (language identifier preserved)
- Inline code (`pre.inline`) properly extracted as backticks
- SVG tags filtered from copy output
- Empty line cleanup in copied Markdown
- Manager features (mermaid, math) enabled by default
